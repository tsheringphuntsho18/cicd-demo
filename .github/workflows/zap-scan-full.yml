name: ZAP Full Scan

on:
    push

jobs:
    zap-full-scan:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5

            - name: Set up JDK 17
              uses: actions/setup-java@v5
              with:
                  java-version: "17"
                  distribution: "temurin"

            - name: Build and run app
              run: |
                  mvn clean package -DskipTests
                  docker build -t cicd-demo:test .
                  docker run -d -p 8080:8080 --name app cicd-demo:test
                  timeout 60 bash -c 'until curl -f http://localhost:8080/; do sleep 2; done'

            - name: ZAP Full Scan
              uses: zaproxy/action-full-scan@v0.12.0
              with:
                  target: "http://localhost:8080"
                  rules_file_name: ".zap/rules.tsv"
                  cmd_options: "-a -j -m 15"

            - name: Upload Reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: zap-full-reports
                  path: |
                      report_html.html
                      report_json.json
                      report_md.md

            - name: Cleanup
              if: always()
              run: docker stop app && docker rm app
