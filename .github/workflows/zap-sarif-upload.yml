name: ZAP SARIF Upload

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

jobs:
    zap-sarif:
        runs-on: ubuntu-latest

        permissions:
            security-events: write
            contents: read

        steps:
            - uses: actions/checkout@v5

            - name: Set up environment
              run: |
                  mvn clean package -DskipTests
                  docker build -t cicd-demo:test .
                  docker run -d -p 8080:8080 --name app cicd-demo:test
                  timeout 60 bash -c 'until curl -f http://localhost:8080/; do sleep 2; done'

            - name: Run ZAP Scan
              run: |
                  docker run -v $(pwd):/zap/wrk/:rw \
                    -t ghcr.io/zaproxy/zaproxy:stable \
                    zap-baseline.py \
                    -t http://localhost:8080 \
                    -J zap_report.json \
                    -r zap_report.html

            - name: Convert to SARIF
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: zap_report.sarif
                  category: zap-scan

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: zap-reports
                  path: |
                      zap_report.json
                      zap_report.html

            - name: Cleanup
              if: always()
              run: docker stop app && docker rm app
